<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .recording-pulse { animation: pulse-purple 1.5s infinite; }
        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(147, 51, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); }
        }
        /* Hiệu ứng nền Gradient động */
        .bg-animated {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex items-center justify-center p-4">

    <!-- Card Chính -->
    <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl border border-indigo-100 overflow-hidden relative">
        
        <!-- Header màu Tím -->
        <div class="bg-gradient-to-r from-violet-600 to-indigo-600 p-6 text-center relative overflow-hidden">
            <!-- Họa tiết trang trí mờ -->
            <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
            
            <h1 class="text-2xl font-bold text-white relative z-10">TalentFlow AI</h1>
            <div class="mt-2 inline-flex items-center gap-2 bg-white/20 backdrop-blur-md px-4 py-1.5 rounded-full border border-white/30">
                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                <p class="text-white text-sm font-medium" id="questionCounter">Loading Question...</p>
            </div>
        </div>

        <div class="p-6">
            <!-- Khung Video (Bo góc lớn) -->
            <div class="relative w-full aspect-[4/3] bg-slate-900 rounded-3xl overflow-hidden shadow-inner border-[6px] border-white ring-1 ring-indigo-100">
                <video id="myVideo" autoplay muted playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>
                
                <!-- Nhãn trạng thái -->
                <div id="statusBadge" class="absolute top-4 right-4 bg-black/60 backdrop-blur-md text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center gap-2 border border-white/10">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span> Ready
                </div>
            </div>

            <!-- Khu vực câu hỏi -->
            <div class="mt-6 mb-6">
                <div class="bg-indigo-50/50 p-5 rounded-2xl border border-indigo-100">
                    <h3 class="text-indigo-400 text-xs font-bold uppercase tracking-wider mb-2 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                        Question
                    </h3>
                    <p id="questionContent" class="text-slate-800 text-lg font-bold leading-snug">
                        Connecting to server...
                    </p>
                </div>
            </div>

            <!-- Nút điều khiển (Màu tím) -->
            <div class="space-y-3">
                <button id="btnStart" onclick="startRecording()" class="group w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-violet-500/30 transition-all transform active:scale-95 flex items-center justify-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center group-hover:bg-white/30 transition">
                        <div class="w-4 h-4 bg-white rounded-full"></div>
                    </div>
                    Start Recording
                </button>

                <button id="btnStop" onclick="stopRecording()" class="hidden w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-rose-500/30 transition-all recording-pulse flex items-center justify-center gap-3">
                    <div class="w-4 h-4 bg-white rounded-sm"></div>
                    Stop & Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Dữ liệu JSON an toàn -->
    <script id="questions-data" type="application/json">
        {{ questions | tojson }}
    </script>

    <script>
        // LOGIC GIỮ NGUYÊN - CHỈ THAY ĐỔI GIAO DIỆN
        let questions = [];
        try {
            questions = JSON.parse(document.getElementById('questions-data').textContent);
        } catch (e) { questions = ["Tell me about yourself?"]; }

        let currentIdx = 0;         
        let mediaRecorder;          
        let recordedChunks = [];    

        updateUI();
        initCamera();

        function initCamera() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    document.getElementById('myVideo').srcObject = stream;
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                    mediaRecorder.onstop = uploadVideo;
                })
                .catch(err => alert("⚠️ Camera Error: Please enable permissions or use HTTPS."));
        }

        function updateUI() {
            if (currentIdx < questions.length) {
                document.getElementById('questionCounter').innerText = `Question ${currentIdx + 1} of ${questions.length}`;
                document.getElementById('questionContent').innerText = questions[currentIdx];
                document.getElementById('btnStart').style.display = 'flex';
                document.getElementById('btnStop').style.display = 'none';
                
                const badge = document.getElementById('statusBadge');
                badge.innerHTML = '<span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> Ready';
                badge.className = "absolute top-4 right-4 bg-black/50 backdrop-blur-md text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center gap-2 border border-white/10";
            } else {
                // CHUYỂN HƯỚNG SANG TRANG REVIEW
                window.location.href = "/candidate/review";
            }
        }

        function startRecording() {
            recordedChunks = [];
            mediaRecorder.start();
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnStop').style.display = 'flex';
            
            const badge = document.getElementById('statusBadge');
            badge.innerHTML = '<span class="w-2 h-2 bg-rose-500 rounded-full animate-ping"></span> Recording';
            badge.className = "absolute top-4 right-4 bg-rose-500/90 text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center gap-2 shadow-lg shadow-rose-500/50";
        }

        function stopRecording() {
            mediaRecorder.stop();
            const badge = document.getElementById('statusBadge');
            badge.innerHTML = '<svg class="animate-spin h-3 w-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Uploading...';
            badge.className = "absolute top-4 right-4 bg-indigo-600 text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center gap-2";
            
            document.getElementById('btnStop').innerText = "Uploading to Server...";
            document.getElementById('btnStop').disabled = true;
            document.getElementById('btnStop').classList.add('opacity-75', 'cursor-not-allowed');
        }

        function uploadVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            if (blob.size < 1000) {
                alert("Video too short! Please record again.");
                updateUI(); return;
            }

            const formData = new FormData();
            formData.append('video', blob);
            formData.append('question_index', currentIdx);
            
            fetch('/upload_video', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        setTimeout(() => {
                            currentIdx++;
                            updateUI();
                            const btnStop = document.getElementById('btnStop');
                            btnStop.innerHTML = `<div class="w-4 h-4 bg-white rounded-sm"></div> Stop & Submit`;
                            btnStop.disabled = false;
                            btnStop.classList.remove('opacity-75', 'cursor-not-allowed');
                        }, 800);
                    } else {
                        alert("Upload Failed: " + data.message);
                        updateUI();
                    }
                })
                .catch(err => {
                    alert("Network Error!");
                    updateUI();
                });
        }
    </script>
</body>
</html>