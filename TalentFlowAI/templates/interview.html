<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
        }

        .recording-pulse {
            animation: pulse-purple 1.5s infinite;
        }

        @keyframes pulse-purple {
            0% {
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(147, 51, 234, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(147, 51, 234, 0);
            }
        }
    </style>
</head>

<body class="bg-indigo-50 min-h-screen flex items-center justify-center p-4">

    <!-- Card Chính -->
    <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl border border-indigo-100 overflow-hidden relative">

        <!-- Header -->
        <div class="bg-gradient-to-r from-violet-600 to-indigo-600 p-6 text-center relative">
            <h1 class="text-2xl font-bold text-white relative z-10">TalentFlow AI</h1>
            <div
                class="mt-2 inline-flex items-center gap-2 bg-white/20 backdrop-blur-md px-4 py-1.5 rounded-full border border-white/30">
                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                <p class="text-white text-sm font-medium" id="questionCounter">Loading...</p>
            </div>
        </div>

        <div class="p-6">
            <!-- Khung Video -->
            <div
                class="relative w-full aspect-[4/3] bg-slate-900 rounded-3xl overflow-hidden shadow-inner border-[6px] border-white ring-1 ring-indigo-100">
                <video id="myVideo" autoplay muted playsinline
                    class="w-full h-full object-cover transform scale-x-[-1]"></video>
                <div id="statusBadge"
                    class="absolute top-4 right-4 bg-black/60 backdrop-blur-md text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center gap-2 border border-white/10">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span> Ready
                </div>
            </div>

            <!-- KHU VỰC CÂU HỎI -->
            <div class="mt-6 mb-6">
                <div class="bg-indigo-50/50 p-6 rounded-2xl border border-indigo-100 min-h-[100px] flex flex-col justify-center items-center text-center transition-all duration-300"
                    id="questionBox">

                    <!-- Icon trang trí lúc chờ -->
                    <div id="waitingIcon" class="mb-2 text-3xl">✨</div>

                    <!-- Nội dung câu hỏi (Hoặc lời nhắc) -->
                    <p id="questionContent" class="text-slate-500 font-medium text-base">
                        Press "Start Recording" to reveal the question...
                    </p>
                </div>
            </div>

            <!-- Nút điều khiển -->
            <div class="space-y-3">
                <button id="btnStart" onclick="startRecording()"
                    class="group w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-violet-500/30 transition-all transform active:scale-95 flex items-center justify-center gap-3">
                    <div
                        class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center group-hover:bg-white/30 transition">
                        <div class="w-4 h-4 bg-white rounded-full"></div>
                    </div>
                    Start Recording & Show Question
                </button>

                <button id="btnStop" onclick="stopRecording()"
                    class="hidden w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-rose-500/30 transition-all recording-pulse flex items-center justify-center gap-3">
                    <div class="w-4 h-4 bg-white rounded-sm"></div>
                    Stop & Submit
                </button>
            </div>
        </div>
    </div>

    <!-- Dữ liệu JSON -->
    <script id="questions-data" type="application/json">
        {{ questions | tojson }}
    </script>

    <script>
        let questions = [];
        try {
            questions = JSON.parse(document.getElementById('questions-data').textContent);
        } catch (e) { questions = ["Tell me about yourself?"]; }

        let currentIdx = 0;
        let mediaRecorder;
        let recordedChunks = [];

        updateUI(); // Gọi hàm này ngay khi vào để hiện trạng thái chờ
        initCamera();

        function initCamera() {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    document.getElementById('myVideo').srcObject = stream;
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                    mediaRecorder.onstop = uploadVideo;
                })
                .catch(err => alert("⚠️ Camera Error! Please check permissions."));
        }

        function updateUI() {
            if (currentIdx < questions.length) {
                // 1. Cập nhật số thứ tự câu hỏi
                document.getElementById('questionCounter').innerText = `Question ${currentIdx + 1} of ${questions.length}`;

                // 2. ẨN CÂU HỎI, HIỆN LỜI NHẮC
                const qContent = document.getElementById('questionContent');
                qContent.innerText = "Press \"Start Recording\" to reveal the question...";
                qContent.className = "text-slate-400 font-medium text-base italic"; // Style chữ mờ nhạt
                document.getElementById('waitingIcon').style.display = 'block'; // Hiện icon trang trí

                // 3. Reset nút bấm
                document.getElementById('btnStart').style.display = 'flex';
                document.getElementById('btnStop').style.display = 'none';

                // 4. Reset badge
                const badge = document.getElementById('statusBadge');
                badge.innerHTML = '<span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> Ready';
                badge.className = "absolute top-4 right-4 bg-black/50 backdrop-blur-md text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center gap-2 border border-white/10";
            } else {
                window.location.href = "/candidate/review";
            }
        }

        function startRecording() {
            // 1. HIỆN CÂU HỎI THẬT
            const qContent = document.getElementById('questionContent');
            qContent.innerText = questions[currentIdx]; // Lấy nội dung thật
            qContent.className = "text-slate-800 text-xl font-bold leading-snug animate-fade-in-up"; // Style chữ đậm, to, rõ
            document.getElementById('waitingIcon').style.display = 'none'; // Ẩn icon trang trí

            // 2. Bắt đầu quay
            recordedChunks = [];
            mediaRecorder.start();

            // 3. Đổi nút
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnStop').style.display = 'flex';

            // 4. Đổi badge sang đỏ
            const badge = document.getElementById('statusBadge');
            badge.innerHTML = '<span class="w-2 h-2 bg-rose-500 rounded-full animate-ping"></span> Recording';
            badge.className = "absolute top-4 right-4 bg-rose-500/90 text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center gap-2 shadow-lg shadow-rose-500/50";
        }

        function stopRecording() {
            mediaRecorder.stop();
            const badge = document.getElementById('statusBadge');
            badge.innerHTML = 'Uploading...';
            badge.className = "absolute top-4 right-4 bg-indigo-600 text-white text-xs font-bold px-3 py-1.5 rounded-full flex items-center gap-2";

            document.getElementById('btnStop').innerText = "Saving Answer...";
            document.getElementById('btnStop').disabled = true;
        }

        function uploadVideo() {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            // ... (Logic upload giữ nguyên)
            const formData = new FormData();
            formData.append('video', blob);
            formData.append('question_index', currentIdx);

            fetch('/upload_video', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        setTimeout(() => {
                            currentIdx++;
                            updateUI(); // Chuyển câu -> Tự động ẩn lại
                            const btnStop = document.getElementById('btnStop');
                            btnStop.innerHTML = `<div class="w-4 h-4 bg-white rounded-sm"></div> Stop & Submit`;
                            btnStop.disabled = false;
                        }, 800);
                    } else {
                        alert("Error: " + data.message);
                        updateUI();
                    }
                })
                .catch(err => {
                    alert("Network Error");
                    updateUI();
                });
        }
    </script>
</body>

</html>